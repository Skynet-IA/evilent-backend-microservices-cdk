# ============================================
# Makefile - IAM Policies (AWS CDK)
# ============================================
# PolÃ­ticas IAM compartidas para todos los servicios Evilent
#
# Uso bÃ¡sico:
#   make deploy          # Desplegar polÃ­ticas
#   make apply-all       # Aplicar a usuario desarrollador
#   make destroy         # Eliminar polÃ­ticas
# ============================================

.PHONY: help install build deploy apply-user-service apply-product-service apply-shared apply-all detach-all destroy clean diff synth status outputs verify

# ============================================
# VARIABLES
# ============================================
AWS_REGION = eu-central-1
IAM_USER = skynet-developer

# Colores
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
BLUE = \033[0;34m
NC = \033[0m

# ============================================
# AYUDA (comando por defecto)
# ============================================
help: ## Muestra esta ayuda
	@echo "$(GREEN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(GREEN)â•‘         IAM POLICIES - COMANDOS DISPONIBLES               â•‘$(NC)"
	@echo "$(GREEN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(RED)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(RED)â•‘  ğŸš€ SETUP INICIAL (ejecutar en orden)                    â•‘$(NC)"
	@echo "$(RED)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "  1ï¸âƒ£  make install            # Instalar dependencias"
	@echo "  2ï¸âƒ£  make deploy              # Desplegar polÃ­ticas IAM"
	@echo "  3ï¸âƒ£  make apply-all           # Aplicar TODAS las polÃ­ticas al usuario"
	@echo ""
	@echo "$(YELLOW)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(YELLOW)â•‘  ğŸ“Š GESTIÃ“N DE POLÃTICAS                                  â•‘$(NC)"
	@echo "$(YELLOW)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "  make apply-user-service      # Solo User Service"
	@echo "  make apply-product-service   # Solo Product Service"
	@echo "  make apply-shared            # Solo Monitoreo Compartido"
	@echo "  make status                  # Ver estado del stack"
	@echo "  make outputs                 # Ver ARNs de polÃ­ticas"
	@echo "  make verify                  # Verificar polÃ­ticas aplicadas"
	@echo ""
	@echo "$(YELLOW)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(YELLOW)â•‘  ğŸ—‘ï¸  LIMPIEZA                                             â•‘$(NC)"
	@echo "$(YELLOW)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "  make detach-all              # Detach TODAS las polÃ­ticas"
	@echo "  make destroy                 # Eliminar stack (requiere detach primero)"
	@echo "  make clean                   # Limpiar archivos compilados"
	@echo ""
	@echo "$(YELLOW)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(YELLOW)â•‘  ğŸ› ï¸  UTILIDADES                                           â•‘$(NC)"
	@echo "$(YELLOW)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "  make build                   # Compilar TypeScript"
	@echo "  make diff                    # Ver diferencias"
	@echo "  make synth                   # Sintetizar template"
	@echo ""
	@echo "$(GREEN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(YELLOW)Variables:$(NC)"
	@echo "  AWS_REGION = $(AWS_REGION)"
	@echo "  IAM_USER = $(IAM_USER)"
	@echo "$(GREEN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"

# ============================================
# 1ï¸âƒ£ SETUP INICIAL
# ============================================

install: ## [PASO 1] Instalar dependencias npm
	@echo "$(GREEN)ğŸ“¦ [1/3] Instalando dependencias...$(NC)"
	npm install
	@echo "$(GREEN)âœ… InstalaciÃ³n completada$(NC)"
	@echo "$(YELLOW)ğŸ’¡ Siguiente: make deploy$(NC)"

deploy: build ## [PASO 2] Desplegar polÃ­ticas IAM
	@echo "$(GREEN)ğŸ” [2/3] Desplegando polÃ­ticas IAM compartidas...$(NC)"
	@echo "$(YELLOW)ğŸ“‹ Stack: IamPoliciesStack$(NC)"
	@echo "$(YELLOW)ğŸ“‹ PolÃ­ticas:$(NC)"
	@echo "   â”œâ”€ EvilentUserServiceDeveloperPolicy"
	@echo "   â”œâ”€ EvilentProductServiceDeveloperPolicy"
	@echo "   â””â”€ EvilentSharedMonitoringPolicy"
	@echo ""
	CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) \
	CDK_DEFAULT_REGION=$(AWS_REGION) \
	npx cdk deploy --require-approval never
	@echo ""
	@echo "$(GREEN)âœ… PolÃ­ticas IAM desplegadas$(NC)"
	@echo "$(YELLOW)ğŸ’¡ Siguiente: make apply-all$(NC)"

apply-all: apply-user-service apply-product-service apply-shared ## [PASO 3] Aplicar TODAS las polÃ­ticas al usuario
	@echo ""
	@echo "$(GREEN)âœ… TODAS las polÃ­ticas aplicadas exitosamente$(NC)"
	@echo "$(YELLOW)ğŸ’¡ Usuario: $(IAM_USER)$(NC)"
	@echo "$(YELLOW)ğŸ’¡ Verificar: make status$(NC)"

# ============================================
# 2ï¸âƒ£ APLICAR POLÃTICAS INDIVIDUALES
# ============================================

apply-user-service: ## Aplicar polÃ­tica de User Service
	@echo "$(GREEN)ğŸ” Aplicando polÃ­tica de User Service...$(NC)"
	@POLICY_ARN=$$(aws cloudformation describe-stacks \
		--stack-name IamPoliciesStack \
		--region $(AWS_REGION) \
		--query 'Stacks[0].Outputs[?OutputKey==`UserServicePolicyArn`].OutputValue' \
		--output text 2>/dev/null); \
	if [ -n "$$POLICY_ARN" ] && [ "$$POLICY_ARN" != "None" ]; then \
		echo "$(YELLOW)ğŸ”— ARN: $$POLICY_ARN$(NC)"; \
		aws iam attach-user-policy \
			--user-name $(IAM_USER) \
			--policy-arn "$$POLICY_ARN" \
			--region $(AWS_REGION) 2>/dev/null || echo "$(YELLOW)   Ya aplicada$(NC)"; \
		echo "$(GREEN)âœ… PolÃ­tica User Service aplicada$(NC)"; \
	else \
		echo "$(RED)âŒ No se encontrÃ³ IamPoliciesStack$(NC)"; \
		exit 1; \
	fi

apply-product-service: ## Aplicar polÃ­tica de Product Service
	@echo "$(GREEN)ğŸ” Aplicando polÃ­tica de Product Service...$(NC)"
	@POLICY_ARN=$$(aws cloudformation describe-stacks \
		--stack-name IamPoliciesStack \
		--region $(AWS_REGION) \
		--query 'Stacks[0].Outputs[?OutputKey==`ProductServicePolicyArn`].OutputValue' \
		--output text 2>/dev/null); \
	if [ -n "$$POLICY_ARN" ] && [ "$$POLICY_ARN" != "None" ]; then \
		echo "$(YELLOW)ğŸ”— ARN: $$POLICY_ARN$(NC)"; \
		aws iam attach-user-policy \
			--user-name $(IAM_USER) \
			--policy-arn "$$POLICY_ARN" \
			--region $(AWS_REGION) 2>/dev/null || echo "$(YELLOW)   Ya aplicada$(NC)"; \
		echo "$(GREEN)âœ… PolÃ­tica Product Service aplicada$(NC)"; \
	else \
		echo "$(RED)âŒ No se encontrÃ³ IamPoliciesStack$(NC)"; \
		exit 1; \
	fi

apply-shared: ## Aplicar polÃ­tica compartida de monitoreo
	@echo "$(GREEN)ğŸ” Aplicando polÃ­tica compartida...$(NC)"
	@POLICY_ARN=$$(aws cloudformation describe-stacks \
		--stack-name IamPoliciesStack \
		--region $(AWS_REGION) \
		--query 'Stacks[0].Outputs[?OutputKey==`SharedMonitoringPolicyArn`].OutputValue' \
		--output text 2>/dev/null); \
	if [ -n "$$POLICY_ARN" ] && [ "$$POLICY_ARN" != "None" ]; then \
		echo "$(YELLOW)ğŸ”— ARN: $$POLICY_ARN$(NC)"; \
		aws iam attach-user-policy \
			--user-name $(IAM_USER) \
			--policy-arn "$$POLICY_ARN" \
			--region $(AWS_REGION) 2>/dev/null || echo "$(YELLOW)   Ya aplicada$(NC)"; \
		echo "$(GREEN)âœ… PolÃ­tica compartida aplicada$(NC)"; \
	else \
		echo "$(RED)âŒ No se encontrÃ³ IamPoliciesStack$(NC)"; \
		exit 1; \
	fi

# ============================================
# 3ï¸âƒ£ INFORMACIÃ“N Y ESTADO
# ============================================

status: ## Ver estado del stack
	@echo "$(GREEN)ğŸ“Š Estado del Stack:$(NC)"
	@echo ""
	@aws cloudformation describe-stacks \
		--stack-name IamPoliciesStack \
		--region $(AWS_REGION) \
		--query 'Stacks[0].[StackName, StackStatus, CreationTime]' \
		--output table 2>/dev/null || echo "$(YELLOW)Stack no encontrado$(NC)"

outputs: ## Ver ARNs de todas las polÃ­ticas
	@echo "$(GREEN)ğŸ“¤ Outputs del Stack:$(NC)"
	@echo ""
	@aws cloudformation describe-stacks \
		--stack-name IamPoliciesStack \
		--region $(AWS_REGION) \
		--query 'Stacks[0].Outputs' \
		--output table 2>/dev/null || echo "$(YELLOW)Stack no encontrado$(NC)"

verify: ## Verificar polÃ­ticas aplicadas al usuario
	@echo "$(GREEN)ğŸ” Verificando polÃ­ticas aplicadas a $(IAM_USER)...$(NC)"
	@echo ""
	@echo "$(YELLOW)PolÃ­ticas Evilent attached:$(NC)"
	@aws iam list-attached-user-policies \
		--user-name $(IAM_USER) \
		--region $(AWS_REGION) \
		--query 'AttachedPolicies[?contains(PolicyName, `Evilent`)]' \
		--output table 2>/dev/null || echo "$(RED)Usuario no encontrado o sin polÃ­ticas$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ’¡ Para ver todas las polÃ­ticas: aws iam list-attached-user-policies --user-name $(IAM_USER)$(NC)"

# ============================================
# 4ï¸âƒ£ LIMPIEZA Y DESTRUCCIÃ“N
# ============================================

detach-all: ## Detach TODAS las polÃ­ticas del usuario
	@echo "$(YELLOW)ğŸ—‘ï¸  Detaching TODAS las polÃ­ticas de $(IAM_USER)...$(NC)"
	@echo ""
	@for OUTPUT_KEY in UserServicePolicyArn ProductServicePolicyArn SharedMonitoringPolicyArn; do \
		POLICY_ARN=$$(aws cloudformation describe-stacks \
			--stack-name IamPoliciesStack \
			--region $(AWS_REGION) \
			--query "Stacks[0].Outputs[?OutputKey=='$$OUTPUT_KEY'].OutputValue" \
			--output text 2>/dev/null || echo ""); \
		if [ -n "$$POLICY_ARN" ] && [ "$$POLICY_ARN" != "None" ]; then \
			echo "$(YELLOW)Detaching $$OUTPUT_KEY...$(NC)"; \
			aws iam detach-user-policy \
				--user-name $(IAM_USER) \
				--policy-arn "$$POLICY_ARN" \
				--region $(AWS_REGION) 2>/dev/null || echo "$(YELLOW)   Ya detached$(NC)"; \
		fi; \
	done
	@echo ""
	@echo "$(GREEN)âœ… Todas las polÃ­ticas detached$(NC)"

destroy: ## Eliminar stack de polÃ­ticas (requiere detach primero)
	@echo "$(RED)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(RED)â•‘  âš ï¸  ADVERTENCIA: Esto eliminarÃ¡ TODAS las polÃ­ticas IAM â•‘$(NC)"
	@echo "$(RED)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)PolÃ­ticas que se eliminarÃ¡n:$(NC)"
	@echo "  â€¢ EvilentUserServiceDeveloperPolicy"
	@echo "  â€¢ EvilentProductServiceDeveloperPolicy"
	@echo "  â€¢ EvilentSharedMonitoringPolicy"
	@echo ""
	@echo "$(YELLOW)âš ï¸  AsegÃºrate de haber ejecutado: make detach-all$(NC)"
	@echo ""
	@echo "$(RED)Presiona Ctrl+C para CANCELAR o Enter para CONTINUAR...$(NC)"
	@read confirm
	@echo ""
	@echo "$(YELLOW)ğŸ—‘ï¸  Eliminando IamPoliciesStack...$(NC)"
	CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) \
	CDK_DEFAULT_REGION=$(AWS_REGION) \
	npx cdk destroy --force
	@echo ""
	@echo "$(GREEN)âœ… IamPoliciesStack eliminado$(NC)"

clean: ## Limpiar archivos compilados
	@echo "$(YELLOW)ğŸ§¹ Limpiando archivos compilados...$(NC)"
	rm -rf dist
	rm -rf cdk.out
	rm -rf lib/**/*.js lib/**/*.d.ts
	rm -rf bin/*.js bin/*.d.ts
	@echo "$(GREEN)âœ… Limpieza completada$(NC)"

# ============================================
# 5ï¸âƒ£ UTILIDADES
# ============================================

build: ## Compilar TypeScript
	@echo "$(GREEN)ğŸ”¨ Compilando TypeScript...$(NC)"
	npm run build
	@echo "$(GREEN)âœ… CompilaciÃ³n exitosa$(NC)"

diff: build ## Ver diferencias con el stack desplegado
	@echo "$(GREEN)ğŸ” Comparando cambios...$(NC)"
	npx cdk diff

synth: build ## Sintetizar template de CloudFormation
	@echo "$(GREEN)ğŸ“„ Sintetizando template...$(NC)"
	npx cdk synth

# ============================================
# COMANDO POR DEFECTO
# ============================================
.DEFAULT_GOAL := help

