# ============================================
# Makefile - User Service (AWS CDK)
# ============================================
# Comandos esenciales para gestionar el stack en AWS
#
# Uso bÃ¡sico:
#   make deploy COGNITO_POOL_ID=eu-central-1_abc123  # Desplegar stack
#   make logs                                          # Ver logs
#   make destroy                                       # Eliminar stack
#
# Variables importantes:
#   COGNITO_POOL_ID: ID del User Pool de Cognito (REQUERIDO para deploy)
#   AWS_REGION: RegiÃ³n de AWS (default: eu-central-1)
# ============================================

.PHONY: help install deploy-policies bastion-policy-apply deploy build prepare-lambda update logs logs-follow status outputs bastion-status bastion-stop bastion-start bastion-connect bastion-psql bastion-migrate destroy-service destroy clean diff synth test-all test-unit test-integration test-database test-database-proxy setup-db-env test-info

# ============================================
# VARIABLES
# ============================================
AWS_REGION = eu-central-1
# COGNITO_POOL_ID = [REDACTED - Configure via environment variable]

# Colores
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m

# ============================================
# AYUDA (comando por defecto)
# ============================================
help: ## Muestra esta ayuda
	@echo "$(GREEN)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(GREEN)â•‘         USER SERVICE - COMANDOS DISPONIBLES               â•‘$(NC)"
	@echo "$(GREEN)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(RED)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(RED)â•‘  ğŸš€ SETUP INICIAL (ejecutar en orden, una sola vez)      â•‘$(NC)"
	@echo "$(RED)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "  0ï¸âƒ£  cd ../iam-policies && make deploy  # PolÃ­ticas IAM (PRIMERO)"
	@echo "  1ï¸âƒ£  make install                        # Instalar dependencias"
	@echo "  2ï¸âƒ£  make bastion-policy-apply           # Aplicar permisos al usuario"
	@echo "  3ï¸âƒ£  make deploy COGNITO_POOL_ID=xxx     # Desplegar servicio"
	@echo ""
	@echo "$(YELLOW)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(YELLOW)â•‘  ğŸ“Š USO DIARIO                                            â•‘$(NC)"
	@echo "$(YELLOW)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "  make update COGNITO_POOL_ID=xxx  # Actualizar cÃ³digo del servicio"
	@echo "  make logs                        # Ver logs de Lambda"
	@echo "  make logs-follow                 # Seguir logs en tiempo real"
	@echo "  make status                      # Ver estado del stack"
	@echo "  make outputs                     # Ver API URL, DB endpoint, etc"
	@echo ""
	@echo "$(YELLOW)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(YELLOW)â•‘  ğŸ–¥ï¸  GESTIÃ“N DE BASTION (ahorro de costos)               â•‘$(NC)"
	@echo "$(YELLOW)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "  make bastion-status              # Ver estado del Bastion"
	@echo "  make bastion-stop                # Detener (ahorra ~$6/mes)"
	@echo "  make bastion-start               # Iniciar cuando lo necesites"
	@echo "  make bastion-connect             # Conectar via SSM"
	@echo "  make bastion-psql                # Acceso directo a PostgreSQL"
	@echo "  make bastion-migrate             # Ejecutar migraciones de DB"
	@echo ""
	@echo "$(YELLOW)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(YELLOW)â•‘  ğŸ—‘ï¸  LIMPIEZA                                             â•‘$(NC)"
	@echo "$(YELLOW)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "  make destroy-service             # Solo servicio (mantiene polÃ­ticas $$0)"
	@echo "  make destroy                     # TODO incluyendo polÃ­ticas"
	@echo "  make clean                       # Limpiar archivos compilados"
	@echo ""
	@echo "$(YELLOW)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(YELLOW)â•‘  ğŸ› ï¸  UTILIDADES (avanzado)                                â•‘$(NC)"
	@echo "$(YELLOW)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "  make build                       # Compilar TypeScript"
	@echo "  make prepare-lambda              # Preparar deployment package"
	@echo "  make diff                        # Ver diferencias antes de deployar"
	@echo "  make synth                       # Sintetizar CloudFormation template"
	@echo ""
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘  ğŸ§ª TESTING                                                â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "  make test-info                   # ğŸ“– Ver explicaciÃ³n de cada tipo de test"
	@echo "  make test-unit                   # ğŸ§ª Unitarios (sin dependencias)"
	@echo "  make test-integration            # ğŸŒ HTTP (requiere API desplegada)"
	@echo "  make test-database-proxy         # ğŸ—„ï¸  PostgreSQL AUTOMÃTICO (recomendado)"
	@echo "  make test-database               # ğŸ—„ï¸  PostgreSQL manual (requiere tÃºnel)"
	@echo "  make test-all                    # ğŸš€ TODOS los tests"
	@echo "  make setup-db-env                # ğŸ”§ Configurar entorno para DB tests"
	@echo ""
	@echo "$(GREEN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo "$(YELLOW)Variables:$(NC)"
	@echo "  AWS_REGION = $(AWS_REGION)"
	@echo "  COGNITO_POOL_ID = $(COGNITO_POOL_ID)"
	@echo "$(GREEN)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"

# ============================================
# 1ï¸âƒ£ SETUP INICIAL (ejecutar en orden)
# ============================================

install: ## [PASO 1] Instalar dependencias npm
	@echo "$(GREEN)ğŸ“¦ [1/3] Instalando dependencias...$(NC)"
	npm install
	@echo "$(GREEN)âœ… InstalaciÃ³n completada$(NC)"
	@echo "$(YELLOW)ğŸ’¡ IMPORTANTE: Primero despliega polÃ­ticas IAM$(NC)"
	@echo "$(YELLOW)   cd ../iam-policies && make deploy$(NC)"
	@echo "$(YELLOW)ğŸ’¡ Siguiente: make bastion-policy-apply$(NC)"

bastion-policy-apply: ## [PASO 2] Aplicar permisos IAM al usuario desarrollador
	@echo "$(GREEN)ğŸ” [2/3] Aplicando permisos al usuario...$(NC)"
	@echo "$(YELLOW)ğŸ“‹ Usuario: skynet-developer$(NC)"
	@echo "$(YELLOW)âš ï¸  NOTA: PolÃ­ticas IAM ahora se gestionan en ../iam-policies/$(NC)"
	@echo ""
	@POLICY_ARN=$$(aws cloudformation describe-stacks \
		--stack-name IamPoliciesStack \
		--region $(AWS_REGION) \
		--query 'Stacks[0].Outputs[?OutputKey==`UserServicePolicyArn`].OutputValue' \
		--output text 2>/dev/null); \
	if [ -n "$$POLICY_ARN" ] && [ "$$POLICY_ARN" != "None" ]; then \
		echo "$(YELLOW)ğŸ”— ARN: $$POLICY_ARN$(NC)"; \
		aws iam attach-user-policy \
			--user-name skynet-developer \
			--policy-arn "$$POLICY_ARN" \
			--region $(AWS_REGION); \
		echo "$(GREEN)âœ… Permisos aplicados$(NC)"; \
		echo ""; \
		echo "$(YELLOW)ğŸ’¡ Siguiente: make deploy COGNITO_POOL_ID=tu_pool_id$(NC)"; \
	else \
		echo "$(RED)âŒ No se encontrÃ³ IamPoliciesStack$(NC)"; \
		echo "$(YELLOW)ğŸ’¡ Ejecuta: cd ../iam-policies && make deploy$(NC)"; \
		exit 1; \
	fi

deploy: prepare-lambda ## [PASO 3] Desplegar servicio completo CON base de datos
	@echo "$(GREEN)ğŸš€ [3/3] Desplegando servicio completo...$(NC)"
	@if [ -z "$(COGNITO_POOL_ID)" ] || [ -z "$(COGNITO_APP_CLIENT_ID)" ]; then \
		echo "$(RED)âŒ ERROR: Debes configurar COGNITO_POOL_ID y COGNITO_APP_CLIENT_ID$(NC)"; \
		echo "$(YELLOW)Uso: make deploy COGNITO_POOL_ID=eu-central-1_abc123 COGNITO_APP_CLIENT_ID=xyz123$(NC)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)ğŸ“‹ ConfiguraciÃ³n:$(NC)"
	@echo "  Stack: UserServiceStack"
	@echo "  Cognito Pool: $(COGNITO_POOL_ID)"
	@echo "  Cognito App Client: $(COGNITO_APP_CLIENT_ID)"
	@echo "  RegiÃ³n: $(AWS_REGION)"
	@echo "  Base de datos: âœ… Activada (Single-AZ, t4g.micro)"
	@echo ""
	CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) \
	CDK_DEFAULT_REGION=$(AWS_REGION) \
	npx cdk deploy UserServiceStack \
		-c cognitoPoolId=$(COGNITO_POOL_ID) \
		-c cognitoAppClientId=$(COGNITO_APP_CLIENT_ID) \
		-c withDatabase=true \
		-c multiAz=false \
		--require-approval never
	@echo ""
	@echo "$(GREEN)âœ… Â¡Setup completo! Servicio desplegado$(NC)"
	@echo "$(YELLOW)ğŸ’¡ Ver API URL: make outputs$(NC)"
	@echo "$(YELLOW)ğŸ’¡ Ver logs: make logs$(NC)"
	@echo "$(YELLOW)ğŸ’¡ Detener Bastion para ahorrar: make bastion-stop$(NC)"

# ============================================
# 2ï¸âƒ£ USO DIARIO
# ============================================

build: ## Compilar TypeScript (se ejecuta automÃ¡ticamente en deploy/update)
	@echo "$(GREEN)ğŸ”¨ Compilando TypeScript...$(NC)"
	npm run build
	@echo "$(GREEN)âœ… CompilaciÃ³n exitosa$(NC)"

prepare-lambda: build ## Preparar deployment package de Lambda desde dist/
	@echo "$(GREEN)ğŸ“¦ Preparando deployment package de Lambda...$(NC)"
	@echo "$(YELLOW)   â””â”€ Creando directorio lambda-deploy/...$(NC)"
	@mkdir -p lambda-deploy
	@echo "$(YELLOW)   â””â”€ Limpiando lambda-deploy/...$(NC)"
	@rm -rf lambda-deploy/*
	@echo "$(YELLOW)   â””â”€ Copiando dist/ â†’ lambda-deploy/...$(NC)"
	@cp -r dist/* lambda-deploy/
	@if [ -f index.js ]; then \
		echo "$(YELLOW)   â””â”€ Copiando entry point index.js...$(NC)"; \
		cp index.js lambda-deploy/; \
	fi
	@echo "$(YELLOW)   â””â”€ Copiando package.json...$(NC)"
	@cp package.json lambda-deploy/
	@echo "$(YELLOW)   â””â”€ Instalando dependencias de producciÃ³n...$(NC)"
	@cd lambda-deploy && npm install --production --silent
	@echo "$(GREEN)âœ… Deployment package listo en lambda-deploy/$(NC)"

update: prepare-lambda ## Actualizar cÃ³digo del servicio (mÃ¡s rÃ¡pido que deploy)
	@echo "$(GREEN)ğŸ”„ Actualizando servicio...$(NC)"
	@if [ -z "$(COGNITO_POOL_ID)" ] || [ -z "$(COGNITO_APP_CLIENT_ID)" ]; then \
		echo "$(RED)âŒ ERROR: Debes configurar COGNITO_POOL_ID y COGNITO_APP_CLIENT_ID$(NC)"; \
		echo "$(YELLOW)Uso: make update COGNITO_POOL_ID=eu-central-1_abc123 COGNITO_APP_CLIENT_ID=xyz123$(NC)"; \
		exit 1; \
	fi
	CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) \
	CDK_DEFAULT_REGION=$(AWS_REGION) \
	npx cdk deploy UserServiceStack \
		-c cognitoPoolId=$(COGNITO_POOL_ID) \
		-c cognitoAppClientId=$(COGNITO_APP_CLIENT_ID) \
		-c withDatabase=true \
		-c multiAz=false \
		--require-approval never
	@echo "$(GREEN)âœ… ActualizaciÃ³n completada$(NC)"

logs: ## Ver logs de Lambda (Ãºltimos 30 minutos)
	@echo "$(GREEN)ğŸ“œ Logs de Lambda (Ãºltimos 30 min):$(NC)"
	@FUNCTION_NAME=$$(aws cloudformation describe-stack-resources \
		--stack-name UserServiceStack \
		--region $(AWS_REGION) \
		--query "StackResources[?ResourceType=='AWS::Lambda::Function' && contains(LogicalResourceId, 'UserService')].PhysicalResourceId" \
		--output text 2>/dev/null | head -1); \
	if [ -n "$$FUNCTION_NAME" ]; then \
		LOG_GROUP="/aws/lambda/$$FUNCTION_NAME"; \
		echo "$(YELLOW)ğŸ“‹ Log Group: $$LOG_GROUP$(NC)"; \
		echo ""; \
		aws logs tail "$$LOG_GROUP" --since 30m --region $(AWS_REGION) 2>&1 || echo "$(YELLOW)No hay logs recientes$(NC)"; \
		echo ""; \
		echo "$(YELLOW)ğŸ’¡ Para seguir en tiempo real: make logs-follow$(NC)"; \
	else \
		echo "$(RED)âŒ No se encontrÃ³ funciÃ³n Lambda$(NC)"; \
		echo "$(YELLOW)ğŸ’¡ Verifica que el stack estÃ© desplegado: make status$(NC)"; \
	fi

logs-follow: ## Seguir logs en tiempo real (Ctrl+C para salir)
	@echo "$(GREEN)ğŸ“œ Siguiendo logs en tiempo real...$(NC)"
	@echo "$(YELLOW)ğŸ’¡ Presiona Ctrl+C para salir$(NC)"
	@echo ""
	@FUNCTION_NAME=$$(aws cloudformation describe-stack-resources \
		--stack-name UserServiceStack \
		--region $(AWS_REGION) \
		--query "StackResources[?ResourceType=='AWS::Lambda::Function' && contains(LogicalResourceId, 'UserService')].PhysicalResourceId" \
		--output text 2>/dev/null | head -1); \
	if [ -n "$$FUNCTION_NAME" ]; then \
		LOG_GROUP="/aws/lambda/$$FUNCTION_NAME"; \
		aws logs tail "$$LOG_GROUP" --follow --region $(AWS_REGION); \
	else \
		echo "$(RED)âŒ No se encontrÃ³ funciÃ³n Lambda$(NC)"; \
	fi

status: ## Ver estado del stack
	@echo "$(GREEN)ğŸ“Š Estado del Stack:$(NC)"
	@echo ""
	@aws cloudformation describe-stacks \
		--stack-name UserServiceStack \
		--region $(AWS_REGION) \
		--query 'Stacks[0].[StackName, StackStatus, CreationTime]' \
		--output table 2>/dev/null || echo "$(YELLOW)Stack no encontrado$(NC)"

outputs: ## Ver outputs del stack (API URL, DB endpoint, etc)
	@echo "$(GREEN)ğŸ“¤ Outputs del Stack:$(NC)"
	@echo ""
	@aws cloudformation describe-stacks \
		--stack-name UserServiceStack \
		--region $(AWS_REGION) \
		--query 'Stacks[0].Outputs' \
		--output table 2>/dev/null || echo "$(YELLOW)Stack no encontrado$(NC)"

# ============================================
# 3ï¸âƒ£ GESTIÃ“N DE BASTION (ahorro de costos)
# ============================================

bastion-status: ## Ver estado del Bastion Host
	@echo "$(GREEN)ğŸ“Š Estado del Bastion Host:$(NC)"
	@INSTANCE_ID=$$(aws cloudformation describe-stacks \
		--stack-name UserServiceStack \
		--region $(AWS_REGION) \
		--query 'Stacks[0].Outputs[?contains(OutputKey, `BastionHostInstanceId`)].OutputValue' \
		--output text 2>/dev/null); \
	if [ -n "$$INSTANCE_ID" ] && [ "$$INSTANCE_ID" != "None" ]; then \
		echo "$(YELLOW)âœ… Instance ID: $$INSTANCE_ID$(NC)"; \
		STATE=$$(aws ec2 describe-instances \
			--instance-ids "$$INSTANCE_ID" \
			--region $(AWS_REGION) \
			--query 'Reservations[0].Instances[0].State.Name' \
			--output text 2>/dev/null); \
		if [ "$$STATE" = "running" ]; then \
			echo "$(GREEN)Status: RUNNING âœ…$(NC)"; \
		elif [ "$$STATE" = "stopped" ]; then \
			echo "$(YELLOW)Status: STOPPED (ahorrando costos) ğŸ’¤$(NC)"; \
			echo "$(YELLOW)ğŸ’¡ Para iniciar: make bastion-start$(NC)"; \
		else \
			echo "$(YELLOW)Status: $$STATE$(NC)"; \
		fi; \
		echo "$(YELLOW)RegiÃ³n: $(AWS_REGION)$(NC)"; \
		echo ""; \
		if [ "$$STATE" = "running" ]; then \
			echo "$(GREEN)Conectar con:$(NC)"; \
			echo "  $$ make bastion-connect"; \
			echo ""; \
			echo "$(YELLOW)ğŸ’¡ Para ahorrar costos: make bastion-stop$(NC)"; \
		fi; \
	else \
		echo "$(YELLOW)âš ï¸  No hay Bastion desplegado$(NC)"; \
	fi

bastion-stop: ## Detener Bastion Host (ahorra ~$6/mes)
	@echo "$(GREEN)ğŸ’¤ Deteniendo Bastion Host...$(NC)"
	@INSTANCE_ID=$$(aws cloudformation describe-stacks \
		--stack-name UserServiceStack \
		--region $(AWS_REGION) \
		--query 'Stacks[0].Outputs[?contains(OutputKey, `BastionHostInstanceId`)].OutputValue' \
		--output text 2>/dev/null); \
	if [ -n "$$INSTANCE_ID" ] && [ "$$INSTANCE_ID" != "None" ]; then \
		STATE=$$(aws ec2 describe-instances \
			--instance-ids "$$INSTANCE_ID" \
			--region $(AWS_REGION) \
			--query 'Reservations[0].Instances[0].State.Name' \
			--output text 2>/dev/null); \
		if [ "$$STATE" = "stopped" ]; then \
			echo "$(YELLOW)âš ï¸  El Bastion ya estÃ¡ detenido$(NC)"; \
		elif [ "$$STATE" = "running" ]; then \
			echo "$(YELLOW)ğŸ“‹ Instance ID: $$INSTANCE_ID$(NC)"; \
			aws ec2 stop-instances --instance-ids "$$INSTANCE_ID" --region $(AWS_REGION) > /dev/null; \
			echo "$(GREEN)âœ… Bastion detenido exitosamente$(NC)"; \
			echo "$(YELLOW)ğŸ’° Ahorro estimado: ~$6/mes$(NC)"; \
			echo "$(YELLOW)ğŸ’¡ Para iniciar nuevamente: make bastion-start$(NC)"; \
		else \
			echo "$(YELLOW)âš ï¸  Estado actual: $$STATE (esperando...)$(NC)"; \
		fi; \
	else \
		echo "$(RED)âŒ No se encontrÃ³ instancia Bastion desplegada$(NC)"; \
	fi

bastion-start: ## Iniciar Bastion Host
	@echo "$(GREEN)ğŸš€ Iniciando Bastion Host...$(NC)"
	@INSTANCE_ID=$$(aws cloudformation describe-stacks \
		--stack-name UserServiceStack \
		--region $(AWS_REGION) \
		--query 'Stacks[0].Outputs[?contains(OutputKey, `BastionHostInstanceId`)].OutputValue' \
		--output text 2>/dev/null); \
	if [ -n "$$INSTANCE_ID" ] && [ "$$INSTANCE_ID" != "None" ]; then \
		STATE=$$(aws ec2 describe-instances \
			--instance-ids "$$INSTANCE_ID" \
			--region $(AWS_REGION) \
			--query 'Reservations[0].Instances[0].State.Name' \
			--output text 2>/dev/null); \
		if [ "$$STATE" = "running" ]; then \
			echo "$(YELLOW)âš ï¸  El Bastion ya estÃ¡ ejecutÃ¡ndose$(NC)"; \
		elif [ "$$STATE" = "stopped" ]; then \
			echo "$(YELLOW)ğŸ“‹ Instance ID: $$INSTANCE_ID$(NC)"; \
			aws ec2 start-instances --instance-ids "$$INSTANCE_ID" --region $(AWS_REGION) > /dev/null; \
			echo "$(GREEN)âœ… Bastion iniciado exitosamente$(NC)"; \
			echo "$(YELLOW)â±ï¸  Esperando que estÃ© listo (puede tomar 1-2 minutos)...$(NC)"; \
			aws ec2 wait instance-running --instance-ids "$$INSTANCE_ID" --region $(AWS_REGION); \
			echo "$(GREEN)âœ… Bastion listo para usar$(NC)"; \
			echo "$(YELLOW)ğŸ’¡ Conectar con: make bastion-connect$(NC)"; \
		else \
			echo "$(YELLOW)âš ï¸  Estado actual: $$STATE (esperando...)$(NC)"; \
		fi; \
	else \
		echo "$(RED)âŒ No se encontrÃ³ instancia Bastion desplegada$(NC)"; \
	fi

bastion-connect: ## Conectar al Bastion via SSM Session Manager
	@echo "$(GREEN)ğŸš€ Conectando al Bastion via SSM...$(NC)"
	@INSTANCE_ID=$$(aws cloudformation describe-stacks \
		--stack-name UserServiceStack \
		--region $(AWS_REGION) \
		--query 'Stacks[0].Outputs[?contains(OutputKey, `BastionHostInstanceId`)].OutputValue' \
		--output text 2>/dev/null); \
	if [ -n "$$INSTANCE_ID" ] && [ "$$INSTANCE_ID" != "None" ]; then \
		echo "$(YELLOW)ğŸ“‹ Instancia: $$INSTANCE_ID$(NC)"; \
		echo "$(YELLOW)â„¹ï¸  Presiona 'exit' para desconectar$(NC)\n"; \
		aws ssm start-session --target "$$INSTANCE_ID" --region $(AWS_REGION); \
	else \
		echo "$(RED)âŒ No se encontrÃ³ instancia Bastion desplegada$(NC)"; \
		echo "$(YELLOW)ğŸ’¡ AsegÃºrate de desplegar con: make deploy COGNITO_POOL_ID=tu_id$(NC)"; \
	fi

bastion-psql: ## Conectar a PostgreSQL via Bastion
	@echo "$(GREEN)ğŸ˜ Conectando a PostgreSQL via Bastion...$(NC)"
	@echo "$(YELLOW)   Una vez conectado podrÃ¡s:$(NC)"
	@echo "$(YELLOW)   â€¢ Ver tablas: \\dt$(NC)"
	@echo "$(YELLOW)   â€¢ Ver estructura: \\d tabla$(NC)"
	@echo "$(YELLOW)   â€¢ Ver datos: SELECT * FROM tabla LIMIT 10;$(NC)"
	@echo "$(YELLOW)   â€¢ Salir: \\q$(NC)"
	@echo ""
	@INSTANCE_ID=$$(aws cloudformation describe-stacks \
		--stack-name UserServiceStack \
		--region $(AWS_REGION) \
		--query 'Stacks[0].Outputs[?contains(OutputKey, `BastionHostInstanceId`)].OutputValue' \
		--output text 2>/dev/null); \
	if [ -n "$$INSTANCE_ID" ] && [ "$$INSTANCE_ID" != "None" ]; then \
		echo "$(YELLOW)ğŸ“‹ Instancia: $$INSTANCE_ID$(NC)"; \
		\
		SECRET_ARN=$$(aws cloudformation describe-stacks \
			--stack-name UserServiceStack \
			--region $(AWS_REGION) \
			--query 'Stacks[0].Outputs[?contains(OutputKey, `SecretArn`)].OutputValue' \
			--output text 2>/dev/null); \
		\
		if [ -n "$$SECRET_ARN" ]; then \
			SECRET_JSON=$$(aws secretsmanager get-secret-value \
				--secret-id "$$SECRET_ARN" \
				--region $(AWS_REGION) \
				--query 'SecretString' \
				--output text); \
			\
			DB_ENDPOINT=$$(echo "$$SECRET_JSON" | jq -r '.host'); \
			DB_USER=$$(echo "$$SECRET_JSON" | jq -r '.username'); \
			DB_PASSWORD=$$(echo "$$SECRET_JSON" | jq -r '.password'); \
			DB_NAME="evilent_users"; \
			\
			echo "$(GREEN)âœ… Credenciales obtenidas$(NC)"; \
			echo "$(YELLOW)ğŸ˜ Conectando al Bastion...$(NC)"; \
			echo "$(YELLOW)   Una vez dentro, ejecuta:$(NC)"; \
			echo "$(YELLOW)   PGPASSWORD='$$DB_PASSWORD' psql -h '$$DB_ENDPOINT' -U '$$DB_USER' -d '$$DB_NAME'$(NC)"; \
			echo "$(YELLOW)   Para salir: exit$(NC)"; \
			echo ""; \
			\
			aws ssm start-session --target "$$INSTANCE_ID" --region $(AWS_REGION); \
		else \
			echo "$(RED)âŒ No se pudo obtener el Secret ARN$(NC)"; \
		fi; \
	else \
		echo "$(RED)âŒ No se encontrÃ³ instancia Bastion desplegada$(NC)"; \
		echo "$(YELLOW)ğŸ’¡ AsegÃºrate de desplegar con: make deploy COGNITO_POOL_ID=tu_id$(NC)"; \
	fi

bastion-migrate: ## Ejecutar migraciones de DB via Bastion
	@echo "$(GREEN)ğŸš€ Ejecutando migraciones AUTOMÃTICAS...$(NC)"
	@echo "$(YELLOW)   Esto deberÃ­a funcionar sin intervenciÃ³n manual$(NC)"
	@echo "$(YELLOW)   Si falla, ejecuta: make setup-db-env$(NC)"
	@echo ""
	@if [ ! -f ".db-env.tmp" ]; then \
		echo "$(RED)âŒ Variables de DB no configuradas$(NC)"; \
		echo "$(YELLOW)ğŸ’¡ Ejecuta primero: make setup-db-env$(NC)"; \
		exit 1; \
	fi
	@source .db-env.tmp && bash run-migrations-with-creds.sh || (echo "$(RED)âŒ Error en migraciones$(NC)" && exit 1)

# ============================================
# 4ï¸âƒ£ LIMPIEZA Y DESTRUCCIÃ“N
# ============================================

destroy-service: ## Eliminar solo el servicio (mantiene polÃ­ticas IAM - RECOMENDADO para desarrollo)
	@echo "$(YELLOW)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(YELLOW)â•‘  ğŸ—‘ï¸  Eliminando solo el servicio (polÃ­ticas se mantienen) â•‘$(NC)"
	@echo "$(YELLOW)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)âœ… Ventajas de mantener polÃ­ticas IAM:$(NC)"
	@echo "  â€¢ PolÃ­ticas IAM son GRATUITAS ($0 de costo)"
	@echo "  â€¢ Redeploy mÃ¡s rÃ¡pido (polÃ­ticas ya existen)"
	@echo "  â€¢ Permisos de usuario se mantienen"
	@echo ""
	@echo "$(YELLOW)Recursos que se eliminarÃ¡n:$(NC)"
	@echo "  â€¢ Lambda functions"
	@echo "  â€¢ API Gateway"
	@echo "  â€¢ RDS PostgreSQL (~$$18/mes)"
	@echo "  â€¢ VPC Endpoints (~$$7.5/mes)"
	@echo "  â€¢ Bastion EC2 (~$$5/mes)"
	@echo "  â€¢ Security Groups"
	@echo "  â€¢ Secrets Manager"
	@echo ""
	@echo "$(GREEN)Recursos que se MANTIENEN ($0 costo):$(NC)"
	@echo "  â€¢ âœ… IamPoliciesStack"
	@echo "  â€¢ âœ… EvilentDeveloperBastionPolicy"
	@echo "  â€¢ âœ… Permisos de usuario skynet-developer"
	@echo ""
	@echo "$(YELLOW)â±ï¸  Tiempo estimado: 15-20 minutos$(NC)"
	@echo ""
	@echo "$(YELLOW)Presiona Ctrl+C para CANCELAR o Enter para CONTINUAR...$(NC)"
	@read confirm
	@echo ""
	@echo "$(YELLOW)ğŸ—‘ï¸  Eliminando UserServiceStack...$(NC)"
	CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) \
	CDK_DEFAULT_REGION=$(AWS_REGION) \
	npx cdk destroy UserServiceStack --force
	@echo ""
	@echo "$(GREEN)âœ… UserServiceStack eliminado$(NC)"
	@echo "$(GREEN)âœ… PolÃ­ticas IAM mantenidas (listas para prÃ³ximo deploy)$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ’¡ Para redeploy rÃ¡pido:$(NC)"
	@echo "  $$ make deploy COGNITO_POOL_ID=xxx"
	@echo ""
	@echo "$(YELLOW)ğŸ’¡ Para eliminar TODO (incluyendo polÃ­ticas):$(NC)"
	@echo "  $$ make destroy"

destroy: ## Eliminar el servicio (polÃ­ticas IAM se mantienen en ../iam-policies/)
	@echo "$(RED)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(RED)â•‘  âš ï¸  ADVERTENCIA: Esto eliminarÃ¡ el servicio             â•‘$(NC)"
	@echo "$(RED)â•‘  â„¹ï¸  Las polÃ­ticas IAM se mantienen (gestionadas aparte) â•‘$(NC)"
	@echo "$(RED)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)Proceso de eliminaciÃ³n:$(NC)"
	@echo "  1. Eliminar UserServiceStack"
	@echo "  2. (PolÃ­ticas IAM se mantienen en IamPoliciesStack)"
	@echo ""
	@echo "$(YELLOW)Recursos que se eliminarÃ¡n:$(NC)"
	@echo "  â€¢ Lambda functions"
	@echo "  â€¢ API Gateway"
	@echo "  â€¢ RDS PostgreSQL (base de datos)"
	@echo "  â€¢ VPC y subnets"
	@echo "  â€¢ Security Groups"
	@echo "  â€¢ Secrets Manager"
	@echo "  â€¢ VPC Endpoints"
	@echo ""
	@echo "$(GREEN)Recursos que se MANTIENEN:$(NC)"
	@echo "  â€¢ âœ… IamPoliciesStack (gestionado en ../iam-policies/)"
	@echo "  â€¢ âœ… PolÃ­ticas IAM"
	@echo "  â€¢ âœ… Permisos de usuario"
	@echo ""
	@echo "$(YELLOW)â±ï¸  Tiempo estimado: 15-30 minutos (RDS es lento)$(NC)"
	@echo ""
	@echo "$(RED)Presiona Ctrl+C para CANCELAR o Enter para CONTINUAR...$(NC)"
	@read confirm
	@echo ""
	@echo "$(YELLOW)ğŸ—‘ï¸  Eliminando UserServiceStack...$(NC)"
	@CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) \
	CDK_DEFAULT_REGION=$(AWS_REGION) \
	npx cdk destroy UserServiceStack --force
	@echo ""
	@echo "$(GREEN)âœ… UserServiceStack eliminado$(NC)"
	@echo "$(GREEN)âœ… PolÃ­ticas IAM mantenidas (gestionadas en ../iam-policies/)$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ’¡ Para eliminar polÃ­ticas IAM:$(NC)"
	@echo "$(YELLOW)   cd ../iam-policies && make destroy$(NC)"

clean: ## Limpiar archivos compilados
	@echo "$(YELLOW)ğŸ§¹ Limpiando archivos compilados...$(NC)"
	rm -rf lib/*.js lib/*.d.ts bin/*.js bin/*.d.ts src/*.js src/*.d.ts
	@echo "$(GREEN)âœ… Limpieza completada$(NC)"

# ============================================
# 5ï¸âƒ£ UTILIDADES (avanzado)
# ============================================

diff: build ## Ver diferencias con el stack del servicio desplegado
	@if [ -z "$(COGNITO_POOL_ID)" ] || [ -z "$(COGNITO_APP_CLIENT_ID)" ]; then \
		echo "$(RED)âŒ ERROR: Debes configurar COGNITO_POOL_ID y COGNITO_APP_CLIENT_ID$(NC)"; \
		echo "$(YELLOW)Uso: make diff COGNITO_POOL_ID=eu-central-1_abc123 COGNITO_APP_CLIENT_ID=xyz123$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸ” Comparando cambios en UserServiceStack...$(NC)"
	npx cdk diff UserServiceStack -c cognitoPoolId=$(COGNITO_POOL_ID) -c cognitoAppClientId=$(COGNITO_APP_CLIENT_ID) -c withDatabase=true -c multiAz=false

synth: build ## Sintetizar template de CloudFormation
	@if [ -z "$(COGNITO_POOL_ID)" ] || [ -z "$(COGNITO_APP_CLIENT_ID)" ]; then \
		echo "$(RED)âŒ ERROR: Debes configurar COGNITO_POOL_ID y COGNITO_APP_CLIENT_ID$(NC)"; \
		echo "$(YELLOW)Uso: make synth COGNITO_POOL_ID=eu-central-1_abc123 COGNITO_APP_CLIENT_ID=xyz123$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸ“„ Sintetizando template de UserServiceStack...$(NC)"
	npx cdk synth UserServiceStack -c cognitoPoolId=$(COGNITO_POOL_ID) -c cognitoAppClientId=$(COGNITO_APP_CLIENT_ID) -c withDatabase=true -c multiAz=false

# ============================================
# ğŸ§ª TESTING
# ============================================
# Diferentes tipos de tests segÃºn tu necesidad:
#
# 1. test-unit        â†’ RÃ¡pidos, sin dependencias (mocks)
# 2. test-integration â†’ Requiere API desplegada en AWS
# 3. test-database    â†’ Requiere RDS PostgreSQL + Secrets Manager
# 4. test-all         â†’ Ejecuta TODOS los tests anteriores
# ============================================

.PHONY: test-all test-unit test-integration test-database setup-db-env test-info

test-info: ## ğŸ“– ExplicaciÃ³n de los tipos de tests disponibles
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘  ğŸ§ª TIPOS DE TESTS DISPONIBLES                            â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)1ï¸âƒ£  TESTS UNITARIOS (test-unit)$(NC)"
	@echo "    âœ… Funcionan siempre, sin dependencias externas"
	@echo "    âœ… Usan mocks para simular servicios"
	@echo "    âœ… RÃ¡pidos (< 5 segundos)"
	@echo "    ğŸ“ Comando: $(YELLOW)make test-unit$(NC)"
	@echo ""
	@echo "$(GREEN)2ï¸âƒ£  TESTS DE INTEGRACIÃ“N HTTP (test-integration)$(NC)"
	@echo "    âš ï¸  Requiere: API Gateway + Lambda desplegados"
	@echo "    âœ… Valida endpoints reales en AWS"
	@echo "    âœ… Incluye autenticaciÃ³n con Cognito"
	@echo "    â±ï¸  DuraciÃ³n: ~30-60 segundos"
	@echo "    ğŸ“ Comando: $(YELLOW)make test-integration$(NC)"
	@echo ""
	@echo "$(GREEN)3ï¸âƒ£  TESTS DE BASE DE DATOS (test-database)$(NC)"
	@echo "    ğŸ—ï¸  Requiere: RDS PostgreSQL + Secrets Manager + Bastion"
	@echo "    âœ… Conecta REALMENTE a PostgreSQL (sin mocks)"
	@echo "    âœ… Valida CRUD, constraints, transacciones ACID"
	@echo "    â±ï¸  DuraciÃ³n: ~20-40 segundos"
	@echo "    ğŸ“ Setup: $(YELLOW)make setup-db-env$(NC) (solo primera vez)"
	@echo "    ğŸ“ Comando: $(YELLOW)make test-database$(NC)"
	@echo ""
	@echo "$(GREEN)4ï¸âƒ£  TODOS LOS TESTS (test-all)$(NC)"
	@echo "    ğŸš€ Ejecuta: Unitarios + IntegraciÃ³n + Database"
	@echo "    âš ï¸  Requiere: TODA la infraestructura desplegada"
	@echo "    â±ï¸  DuraciÃ³n: ~1-2 minutos"
	@echo "    ğŸ“ Comando: $(YELLOW)make test-all$(NC)"
	@echo ""
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"

test-unit: ## ğŸ§ª Tests unitarios (SIN dependencias, usan mocks)
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘  ğŸ§ª TESTS UNITARIOS (Mocks)                               â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)âœ… Requisitos: NINGUNO (funcionan siempre)$(NC)"
	@echo "$(GREEN)âš¡ Velocidad: Muy rÃ¡pidos (< 5 segundos)$(NC)"
	@echo ""
	npm run test:unit

test-integration: ## ğŸŒ Tests de integraciÃ³n HTTP (REQUIERE: API desplegada)
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘  ğŸŒ TESTS DE INTEGRACIÃ“N HTTP                             â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)âš ï¸  REQUISITOS:$(NC)"
	@echo "   â€¢ API Gateway desplegada: $(GREEN)make deploy COGNITO_POOL_ID=xxx$(NC)"
	@echo "   â€¢ Lambda function activa"
	@echo "   â€¢ Cognito User Pool configurado"
	@echo ""
	@echo "$(GREEN)ğŸš€ Ejecutando tests contra API real en AWS...$(NC)"
	@echo ""
	npm run test:integration

test-database: ## [DB] Tests de base de datos (REQUIERE: RDS + Secrets + Bastion)
test-database-proxy: ## [DB] Tests DB con tunel automatico SSM (RECOMENDADO)
	@echo "$(BLUE)Sistema de tunel automatico implementado!$(NC)"
	@echo "$(YELLOW)Para usar:$(NC)"
	@echo "  1. make setup-db-env"
	@echo "  2. make test-database-proxy"

	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘  [DB] TESTS DE BASE DE DATOS POSTGRESQL                    â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)[!] REQUISITOS (Infraestructura Real):$(NC)"
	@echo "   1. RDS PostgreSQL desplegado"
	@echo "   2. AWS Secrets Manager con credenciales"
	@echo "   3. Bastion Host ejecutÃ¡ndose"
	@echo "   4. Variables de entorno configuradas"
	@echo ""
	@if [ ! -f ".db-env.tmp" ]; then \
		echo "$(RED)âŒ ERROR: Variables de entorno NO configuradas$(NC)"; \
		echo ""; \
		echo "$(YELLOW)ğŸ”§ SOLUCIÃ“N:$(NC)"; \
		echo "   $(GREEN)make setup-db-env$(NC)  # ConfiguraciÃ³n automÃ¡tica"; \
		echo ""; \
		exit 1; \
	fi
	@echo "$(GREEN)âœ… Variables de entorno configuradas correctamente$(NC)"
	@source .db-env.tmp && echo "   DB_SECRET_ARN: $$DB_SECRET_ARN" && echo "   DB_ENDPOINT: $$DB_ENDPOINT"
	@echo ""
	@echo "$(GREEN)ğŸš€ Ejecutando tests contra PostgreSQL real...$(NC)"
	@echo ""
	@source .db-env.tmp && TUNNEL_AUTO_MODE=true ./create-db-tunnel.sh
test-all: ## ğŸš€ TODOS los tests (unitarios + integraciÃ³n + database)
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘  ğŸš€ EJECUTANDO TODOS LOS TESTS                            â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)âš ï¸  ADVERTENCIA: Esto ejecutarÃ¡:$(NC)"
	@echo "   1ï¸âƒ£  Tests Unitarios (mocks)"
	@echo "   2ï¸âƒ£  Tests de IntegraciÃ³n HTTP (API real)"
	@echo "   3ï¸âƒ£  Tests de Base de Datos (PostgreSQL real)"
	@echo ""
	@echo "$(YELLOW)â±ï¸  DuraciÃ³n estimada: 1-2 minutos$(NC)"
	@echo ""
	@if [ ! -f ".db-env.tmp" ]; then \
		echo "$(RED)âŒ ERROR: Variables de entorno para DB tests no configuradas$(NC)"; \
		echo "$(YELLOW)ğŸ’¡ Ejecutar primero: make setup-db-env$(NC)"; \
		exit 1; \
	fi
	@echo "$(GREEN)ğŸš€ Iniciando suite completa de tests...$(NC)"
	@echo ""
	npm test

setup-db-env: ## ğŸ”§ Configurar variables de entorno para Database Tests
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘  ğŸ”§ CONFIGURACIÃ“N DE ENTORNO PARA DB TESTS                â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(GREEN)ğŸ“‹ Este script obtendrÃ¡ automÃ¡ticamente:$(NC)"
	@echo "   â€¢ DB_SECRET_ARN (desde CloudFormation outputs)"
	@echo "   â€¢ DB_ENDPOINT (desde CloudFormation outputs)"
	@echo "   â€¢ DB_NAME (desde CloudFormation outputs)"
	@echo ""
	@if [ ! -f "./setup-db-test-env.sh" ]; then \
		echo "$(RED)âŒ ERROR: Script setup-db-test-env.sh no encontrado$(NC)"; \
		exit 1; \
	fi
	@chmod +x ./setup-db-test-env.sh
	@./setup-db-test-env.sh
	@echo ""
	@echo "$(GREEN)âœ… ConfiguraciÃ³n completada$(NC)"
	@echo "$(YELLOW)ğŸ’¡ Ahora puedes ejecutar: make test-database$(NC)"

# ============================================
# COMANDO POR DEFECTO
# ============================================
.DEFAULT_GOAL := help
