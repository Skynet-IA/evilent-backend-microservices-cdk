# ============================================
# Makefile - Product Service (AWS CDK)
# ============================================
# Comandos esenciales para gestionar el stack en AWS
#
# Uso b√°sico:
#   make deploy COGNITO_POOL_ID=eu-central-1_abc123  # Desplegar stack
#   make logs                                          # Ver logs
#   make destroy                                       # Eliminar stack
#
# Variables importantes:
#   COGNITO_POOL_ID: ID del User Pool de Cognito (REQUERIDO para deploy)
#   COGNITO_APP_CLIENT_ID: ID del App Client de Cognito (REQUERIDO para deploy)
#   MongoDB: Configurado autom√°ticamente via AWS Secrets Manager (NO requiere configuraci√≥n manual)
#   AWS_REGION: Regi√≥n de AWS (default: eu-central-1)
# ============================================

.PHONY: help install deploy build prepare-lambda update logs logs-follow status outputs destroy clean diff synth test test-all test-unit test-integration test-validation test-helpers test-watch test-coverage test-info validate api-url check-aws list-stacks configure-mongodb mongodb-status

# ============================================
# VARIABLES
# ============================================
AWS_REGION = eu-central-1
STACK_NAME = ProductServiceStack
COGNITO_POOL_ID ?=
COGNITO_APP_CLIENT_ID ?=
MONGODB_URI ?=
MONGODB_SECRET_NAME = prod/product-service/mongodb

# Colores
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
BLUE = \033[0;34m
NC = \033[0m

# ============================================
# AYUDA (comando por defecto)
# ============================================
help: ## Muestra esta ayuda
	@echo "$(GREEN)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(GREEN)‚ïë         PRODUCT SERVICE - COMANDOS DISPONIBLES            ‚ïë$(NC)"
	@echo "$(GREEN)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo ""
	@echo "$(RED)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(RED)‚ïë  üöÄ SETUP INICIAL (ejecutar en orden, una sola vez)      ‚ïë$(NC)"
	@echo "$(RED)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo "  0Ô∏è‚É£  cd ../iam-policies && make deploy  # Pol√≠ticas IAM (PRIMERO)"
	@echo "  1Ô∏è‚É£  make install                        # Instalar dependencias"
	@echo "  2Ô∏è‚É£  make deploy COGNITO_POOL_ID=xxx COGNITO_APP_CLIENT_ID=yyy MONGODB_URI='mongodb://user:pass@host:27017/db'"
	@echo ""
	@echo "$(YELLOW)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(YELLOW)‚ïë  üìä USO DIARIO                                            ‚ïë$(NC)"
	@echo "$(YELLOW)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo "  make update COGNITO_POOL_ID=xxx COGNITO_APP_CLIENT_ID=yyy MONGODB_URI='...'  # Actualizar c√≥digo"
	@echo "  make configure-mongodb MONGODB_URI='mongodb://...'  # Actualizar solo el secret de MongoDB"
	@echo "  make mongodb-status              # Ver estado del secret de MongoDB"
	@echo "  make logs                        # Ver logs de Lambda"
	@echo "  make logs-follow                 # Seguir logs en tiempo real"
	@echo "  make status                      # Ver estado del stack"
	@echo "  make outputs                     # Ver API URL y outputs"
	@echo "  make api-url                     # Obtener solo la URL del API"
	@echo ""
	@echo "$(YELLOW)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(YELLOW)‚ïë  üóëÔ∏è  LIMPIEZA                                             ‚ïë$(NC)"
	@echo "$(YELLOW)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo "  make destroy                     # Eliminar stack (pol√≠ticas IAM se mantienen)"
	@echo "  make clean                       # Limpiar archivos compilados"
	@echo ""
	@echo "$(YELLOW)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(YELLOW)‚ïë  üõ†Ô∏è  UTILIDADES (avanzado)                                ‚ïë$(NC)"
	@echo "$(YELLOW)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo "  make build                       # Compilar TypeScript"
	@echo "  make diff                        # Ver diferencias antes de deployar"
	@echo "  make synth                       # Sintetizar CloudFormation template"
	@echo "  make validate                    # Validar configuraci√≥n (build + synth)"
	@echo "  make check-aws                   # Verificar configuraci√≥n de AWS CLI"
	@echo "  make list-stacks                 # Listar todos los stacks"
	@echo ""
	@echo "$(BLUE)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(BLUE)‚ïë  üß™ TESTING                                                ‚ïë$(NC)"
	@echo "$(BLUE)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo "  make test-info                   # üìñ Ver explicaci√≥n de cada tipo de test"
	@echo "  make test                        # üß™ Ejecutar todos los tests"
	@echo "  make test-validation             # ‚úÖ Tests de validaci√≥n Zod (100% funcionando)"
	@echo "  make test-unit                   # üî¨ Tests unitarios de services"
	@echo "  make test-integration            # üåê Tests de integraci√≥n de APIs"
	@echo "  make test-helpers                # üõ†Ô∏è  Tests de funciones helper"
	@echo "  make test-watch                  # üëÄ Ejecutar tests en modo watch"
	@echo "  make test-coverage               # üìä Tests con reporte de coverage"
	@echo ""
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(YELLOW)Variables:$(NC)"
	@echo "  AWS_REGION = $(AWS_REGION)"
	@echo "  COGNITO_POOL_ID = $(COGNITO_POOL_ID)"
	@echo "  COGNITO_APP_CLIENT_ID = $(COGNITO_APP_CLIENT_ID)"
	@echo "  MONGODB_URI = $(MONGODB_URI)"
	@echo "  MONGODB_SECRET_NAME = $(MONGODB_SECRET_NAME)"
	@echo "  STACK_NAME = $(STACK_NAME)"
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"

# ============================================
# FUNCI√ìN AUXILIAR: Gestionar MongoDB Secret
# ============================================

define update_mongodb_secret
	@if [ -z "$(1)" ]; then \
		echo "$(RED)‚ùå ERROR: MONGODB_URI no configurada$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)üîê Actualizando MongoDB Secret en AWS Secrets Manager...$(NC)"
	@aws secretsmanager put-secret-value \
		--secret-id $(MONGODB_SECRET_NAME) \
		--secret-string "{\"MONGODB_URI\":\"$(1)\"}" \
		--region $(AWS_REGION) 2>/dev/null && \
		echo "$(GREEN)‚úÖ Secret actualizado exitosamente$(NC)" || \
	(aws secretsmanager create-secret \
		--name $(MONGODB_SECRET_NAME) \
		--description "MongoDB URI para Product Service" \
		--secret-string "{\"MONGODB_URI\":\"$(1)\"}" \
		--region $(AWS_REGION) && \
		echo "$(GREEN)‚úÖ Secret creado exitosamente$(NC)")
endef

# ============================================
# 1Ô∏è‚É£ SETUP INICIAL (ejecutar en orden)
# ============================================

install: ## [PASO 1] Instalar dependencias npm
	@echo "$(GREEN)üì¶ [1/2] Instalando dependencias...$(NC)"
	npm install
	@echo "$(GREEN)‚úÖ Instalaci√≥n completada$(NC)"
	@echo "$(YELLOW)üí° IMPORTANTE: Primero despliega pol√≠ticas IAM$(NC)"
	@echo "$(YELLOW)   cd ../iam-policies && make deploy$(NC)"
	@echo "$(YELLOW)üí° Siguiente: make deploy COGNITO_POOL_ID=tu_pool_id COGNITO_APP_CLIENT_ID=tu_client_id MONGODB_URI=tu_uri$(NC)"

deploy: build ## [PASO 2] Desplegar servicio completo
	@echo "$(GREEN)üöÄ [2/2] Desplegando servicio completo...$(NC)"
	@if [ -z "$(COGNITO_POOL_ID)" ]; then \
		echo "$(RED)‚ùå ERROR: Debes configurar COGNITO_POOL_ID$(NC)"; \
		exit 1; \
	fi
	@if [ -z "$(COGNITO_APP_CLIENT_ID)" ]; then \
		echo "$(RED)‚ùå ERROR: Debes configurar COGNITO_APP_CLIENT_ID$(NC)"; \
		exit 1; \
	fi
	@if [ -z "$(MONGODB_URI)" ]; then \
		echo "$(RED)‚ùå ERROR: Debes configurar MONGODB_URI$(NC)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)üìã Configuraci√≥n:$(NC)"
	@echo "  Stack: $(STACK_NAME)"
	@echo "  Cognito Pool: $(COGNITO_POOL_ID)"
	@echo "  Cognito Client: $(COGNITO_APP_CLIENT_ID)"
	@echo "  MongoDB URI: ‚úÖ Configurada"
	@echo "  Regi√≥n: $(AWS_REGION)"
	@echo "  Componentes:"
	@echo "    ‚Ä¢ 4 Lambda Functions (products, categories, deals, images)"
	@echo "    ‚Ä¢ API Gateway REST API"
	@echo "    ‚Ä¢ S3 Bucket para im√°genes"
	@echo "    ‚Ä¢ AWS Secrets Manager para MongoDB"
	@echo "    ‚Ä¢ CloudWatch Logs"
	@echo ""
	@echo "$(BLUE)[1/2] Configurando MongoDB Secret...$(NC)"
	$(call update_mongodb_secret,$(MONGODB_URI))
	@echo ""
	@echo "$(BLUE)[2/2] Desplegando CDK Stack...$(NC)"
	CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) \
	CDK_DEFAULT_REGION=$(AWS_REGION) \
	npx cdk deploy $(STACK_NAME) \
		--parameters CognitoPoolId=$(COGNITO_POOL_ID) \
		--parameters CognitoAppClientId=$(COGNITO_APP_CLIENT_ID) \
		--require-approval never
	@echo ""
	@echo "$(GREEN)‚úÖ Deploy completado al 100%$(NC)"
	@echo "$(YELLOW)üí° Obt√©n la URL del API: make api-url$(NC)"

# ============================================
# 2Ô∏è‚É£ DESARROLLO Y ACTUALIZACIONES
# ============================================

build: ## Compilar TypeScript a JavaScript
	@echo "$(GREEN)üî® Compilando TypeScript...$(NC)"
	npm run build
	@echo "$(GREEN)‚úÖ Compilaci√≥n exitosa$(NC)"

prepare-lambda: build ## Preparar deployment package de Lambda desde dist/
	@echo "$(GREEN)üì¶ Preparando deployment package de Lambda...$(NC)"
	@echo "$(YELLOW)   ‚îî‚îÄ Creando directorio lambda-deploy/...$(NC)"
	@mkdir -p lambda-deploy
	@echo "$(YELLOW)   ‚îî‚îÄ Limpiando lambda-deploy/...$(NC)"
	@rm -rf lambda-deploy/*
	@echo "$(YELLOW)   ‚îî‚îÄ Copiando dist/ ‚Üí lambda-deploy/...$(NC)"
	@cp -r dist/* lambda-deploy/
	@echo "$(YELLOW)   ‚îî‚îÄ Copiando package.json...$(NC)"
	@cp package.json lambda-deploy/
	@echo "$(YELLOW)   ‚îî‚îÄ Instalando dependencias de producci√≥n...$(NC)"
	@cd lambda-deploy && npm install --production --silent
	@echo "$(GREEN)‚úÖ Deployment package listo en lambda-deploy/$(NC)"

update: build ## Actualizar servicio despu√©s de cambios (build + deploy r√°pido)
	@echo "$(GREEN)üîÑ Actualizando servicio...$(NC)"
	@if [ -z "$(COGNITO_POOL_ID)" ]; then \
		echo "$(RED)‚ùå ERROR: Debes configurar COGNITO_POOL_ID$(NC)"; \
		exit 1; \
	fi
	@if [ -z "$(COGNITO_APP_CLIENT_ID)" ]; then \
		echo "$(RED)‚ùå ERROR: Debes configurar COGNITO_APP_CLIENT_ID$(NC)"; \
		exit 1; \
	fi
	@if [ -n "$(MONGODB_URI)" ]; then \
		echo "$(BLUE)[1/2] Actualizando MongoDB Secret...$(NC)"; \
		$(call update_mongodb_secret,$(MONGODB_URI)); \
		echo ""; \
	fi
	@echo "$(BLUE)[2/2] Actualizando CDK Stack...$(NC)"
	CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) \
	CDK_DEFAULT_REGION=$(AWS_REGION) \
	npx cdk deploy $(STACK_NAME) \
		--parameters CognitoPoolId=$(COGNITO_POOL_ID) \
		--parameters CognitoAppClientId=$(COGNITO_APP_CLIENT_ID) \
		--require-approval never
	@echo "$(GREEN)‚úÖ Servicio actualizado$(NC)"

diff: build ## Ver diferencias con el stack desplegado
	@echo "$(GREEN)üîç Comparando cambios...$(NC)"
	CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) \
	CDK_DEFAULT_REGION=$(AWS_REGION) \
	npx cdk diff $(STACK_NAME)

synth: build ## Sintetizar CloudFormation template
	@echo "$(GREEN)üìã Sintetizando template...$(NC)"
	CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) \
	CDK_DEFAULT_REGION=$(AWS_REGION) \
	npx cdk synth $(STACK_NAME)

validate: build synth ## Validar configuraci√≥n (build + synth)
	@echo "$(GREEN)‚úÖ Validaci√≥n exitosa$(NC)"

# ============================================
# 3Ô∏è‚É£ MONITOREO Y LOGS
# ============================================

logs: ## Ver logs de Lambda (√∫ltimos 10 minutos)
	@echo "$(GREEN)üìú Logs de Lambda (√∫ltimos 10 minutos):$(NC)"
	@FUNCTION_NAME=$$(aws cloudformation describe-stack-resources \
		--stack-name $(STACK_NAME) \
		--region $(AWS_REGION) \
		--query "StackResources[?ResourceType=='AWS::Lambda::Function'].PhysicalResourceId" \
		--output text 2>/dev/null | head -1); \
	if [ -n "$$FUNCTION_NAME" ]; then \
		LOG_GROUP="/aws/lambda/$$FUNCTION_NAME"; \
		echo "$(YELLOW)üìã Function: $$FUNCTION_NAME$(NC)"; \
		aws logs tail $$LOG_GROUP --since 10m --region $(AWS_REGION); \
	else \
		echo "$(YELLOW)No se encontr√≥ funci√≥n Lambda desplegada$(NC)"; \
	fi

logs-follow: ## Seguir logs en tiempo real
	@echo "$(GREEN)üìú Siguiendo logs en tiempo real (Ctrl+C para salir):$(NC)"
	@FUNCTION_NAME=$$(aws cloudformation describe-stack-resources \
		--stack-name $(STACK_NAME) \
		--region $(AWS_REGION) \
		--query "StackResources[?ResourceType=='AWS::Lambda::Function'].PhysicalResourceId" \
		--output text 2>/dev/null | head -1); \
	if [ -n "$$FUNCTION_NAME" ]; then \
		LOG_GROUP="/aws/lambda/$$FUNCTION_NAME"; \
		echo "$(YELLOW)üìã Function: $$FUNCTION_NAME$(NC)"; \
		aws logs tail $$LOG_GROUP --follow --region $(AWS_REGION); \
	else \
		echo "$(YELLOW)No se encontr√≥ funci√≥n Lambda desplegada$(NC)"; \
	fi

status: ## Ver estado del stack
	@echo "$(GREEN)üìä Estado del Stack:$(NC)"
	@echo ""
	@aws cloudformation describe-stacks \
		--stack-name $(STACK_NAME) \
		--region $(AWS_REGION) \
		--query 'Stacks[0].[StackName, StackStatus, CreationTime]' \
		--output table 2>/dev/null || echo "$(YELLOW)Stack no encontrado$(NC)"

outputs: ## Ver outputs del stack (API URL, etc.)
	@echo "$(GREEN)üì§ Outputs del Stack:$(NC)"
	@echo ""
	@aws cloudformation describe-stacks \
		--stack-name $(STACK_NAME) \
		--region $(AWS_REGION) \
		--query 'Stacks[0].Outputs' \
		--output table 2>/dev/null || echo "$(YELLOW)Stack no encontrado$(NC)"

api-url: ## Obtener URL del API Gateway
	@echo "$(GREEN)üåê URL del API Gateway:$(NC)"
	@API_URL=$$(aws cloudformation describe-stacks \
		--stack-name $(STACK_NAME) \
		--region $(AWS_REGION) \
		--query 'Stacks[0].Outputs[?contains(OutputKey, `ApiGateway`) || contains(OutputKey, `Endpoint`)].OutputValue' \
		--output text 2>/dev/null); \
	if [ -n "$$API_URL" ]; then \
		echo "$(YELLOW)$$API_URL$(NC)"; \
	else \
		echo "$(YELLOW)Stack no encontrado o no tiene API Gateway desplegado$(NC)"; \
	fi

# ============================================
# 4Ô∏è‚É£ LIMPIEZA Y DESTRUCCI√ìN
# ============================================

destroy: ## Eliminar el servicio (pol√≠ticas IAM se mantienen en ../iam-policies/)
	@echo "$(RED)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(RED)‚ïë  ‚ö†Ô∏è  ADVERTENCIA: Esto eliminar√° el servicio             ‚ïë$(NC)"
	@echo "$(RED)‚ïë  ‚ÑπÔ∏è  Las pol√≠ticas IAM se mantienen (gestionadas aparte) ‚ïë$(NC)"
	@echo "$(RED)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo ""
	@echo "$(YELLOW)Proceso de eliminaci√≥n:$(NC)"
	@echo "  1. Eliminar $(STACK_NAME)"
	@echo "  2. (Pol√≠ticas IAM se mantienen en IamPoliciesStack)"
	@echo ""
	@echo "$(YELLOW)Recursos que se eliminar√°n:$(NC)"
	@echo "  ‚Ä¢ Lambda functions (5 funciones)"
	@echo "  ‚Ä¢ API Gateway"
	@echo "  ‚Ä¢ S3 Bucket (im√°genes)"
	@echo "  ‚Ä¢ CloudWatch Logs"
	@echo "  ‚Ä¢ IAM Roles (creados por el stack)"
	@echo ""
	@echo "$(GREEN)Recursos que se MANTIENEN:$(NC)"
	@echo "  ‚Ä¢ ‚úÖ IamPoliciesStack (gestionado en ../iam-policies/)"
	@echo "  ‚Ä¢ ‚úÖ Pol√≠ticas IAM"
	@echo "  ‚Ä¢ ‚úÖ Permisos de usuario"
	@echo ""
	@echo "$(YELLOW)‚è±Ô∏è  Tiempo estimado: 2-5 minutos$(NC)"
	@echo ""
	@echo "$(RED)Presiona Ctrl+C para CANCELAR o Enter para CONTINUAR...$(NC)"
	@read confirm
	@echo ""
	@echo "$(YELLOW)üóëÔ∏è  Eliminando $(STACK_NAME)...$(NC)"
	@CDK_DEFAULT_ACCOUNT=$$(aws sts get-caller-identity --query Account --output text) \
	CDK_DEFAULT_REGION=$(AWS_REGION) \
	npx cdk destroy $(STACK_NAME) --force
	@echo ""
	@echo "$(GREEN)‚úÖ $(STACK_NAME) eliminado$(NC)"
	@echo "$(GREEN)‚úÖ Pol√≠ticas IAM mantenidas (gestionadas en ../iam-policies/)$(NC)"
	@echo ""
	@echo "$(YELLOW)üí° Para eliminar pol√≠ticas IAM:$(NC)"
	@echo "$(YELLOW)   cd ../iam-policies && make destroy$(NC)"

clean: ## Limpiar archivos compilados y node_modules
	@echo "$(YELLOW)üßπ Limpiando archivos...$(NC)"
	rm -rf node_modules
	rm -rf cdk.out
	rm -rf dist
	rm -rf *.d.ts
	rm -rf *.js
	rm -rf lib/*.d.ts
	rm -rf lib/*.js
	rm -rf src/**/*.d.ts
	rm -rf src/**/*.js
	@echo "$(GREEN)‚úÖ Limpieza completada$(NC)"

# ============================================
# 5Ô∏è‚É£ UTILIDADES
# ============================================

check-aws: ## Verificar configuraci√≥n de AWS CLI
	@echo "$(GREEN)üîç Verificando AWS CLI...$(NC)"
	@aws sts get-caller-identity --region $(AWS_REGION) --query '[Account,Arn]' --output table
	@echo "$(GREEN)‚úÖ AWS CLI configurado correctamente$(NC)"

list-stacks: ## Listar todos los stacks de CloudFormation
	@echo "$(GREEN)üìö Stacks de CloudFormation:$(NC)"
	@aws cloudformation list-stacks \
		--region $(AWS_REGION) \
		--stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
		--query 'StackSummaries[*].[StackName,StackStatus,CreationTime]' \
		--output table

# ============================================
# 6Ô∏è‚É£ TESTING
# ============================================

test-info: ## üìñ Mostrar informaci√≥n detallada sobre los tests disponibles
	@echo "$(BLUE)‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$(NC)"
	@echo "$(BLUE)‚ïë  üìñ GU√çA DE TESTING - PRODUCT SERVICE                     ‚ïë$(NC)"
	@echo "$(BLUE)‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$(NC)"
	@echo ""
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(GREEN)üìä TIPOS DE TESTS DISPONIBLES$(NC)"
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo ""
	@echo "$(YELLOW)1. ‚úÖ TESTS DE VALIDACI√ìN ZOD$(NC) (make test-validation)"
	@echo "   ‚Ä¢ Qu√© prueba: Schemas de validaci√≥n con Zod"
	@echo "   ‚Ä¢ Archivos: test/unit/validation-schemas.test.ts"
	@echo "   ‚Ä¢ Tests: 42 tests"
	@echo "   ‚Ä¢ Estado: ‚úÖ 100% funcionando"
	@echo "   ‚Ä¢ Dependencias: Ninguna"
	@echo "   ‚Ä¢ Tiempo: ~0.2 segundos"
	@echo ""
	@echo "$(YELLOW)2. üî¨ TESTS UNITARIOS$(NC) (make test-unit)"
	@echo "   ‚Ä¢ Qu√© prueba: Services con mocks de repositorios"
	@echo "   ‚Ä¢ Archivos: test/unit/product-service.test.ts"
	@echo "   ‚Ä¢           test/unit/category-service.test.ts"
	@echo "   ‚Ä¢ Tests: 40 tests"
	@echo "   ‚Ä¢ Dependencias: Mocks (sin AWS, sin DB)"
	@echo "   ‚Ä¢ Tiempo: ~1-2 segundos"
	@echo ""
	@echo "$(YELLOW)3. üõ†Ô∏è  TESTS DE HELPERS$(NC) (make test-helpers)"
	@echo "   ‚Ä¢ Qu√© prueba: Funciones helper de validaci√≥n"
	@echo "   ‚Ä¢ Archivos: test/helpers/zod-validator.test.ts"
	@echo "   ‚Ä¢ Tests: 22 tests"
	@echo "   ‚Ä¢ Dependencias: Ninguna"
	@echo "   ‚Ä¢ Tiempo: ~0.5 segundos"
	@echo ""
	@echo "$(YELLOW)4. üåê TESTS DE INTEGRACI√ìN$(NC) (make test-integration)"
	@echo "   ‚Ä¢ Qu√© prueba: Handlers de API con mocks de AWS"
	@echo "   ‚Ä¢ Archivos: test/integration/product-api.test.ts"
	@echo "   ‚Ä¢ Tests: 14 tests"
	@echo "   ‚Ä¢ Dependencias: Mocks de Cognito y S3"
	@echo "   ‚Ä¢ Tiempo: ~1-2 segundos"
	@echo ""
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(GREEN)üìà ESTAD√çSTICAS$(NC)"
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo ""
	@echo "  Total de tests implementados: 118"
	@echo "  Tests verificados funcionando: 42 (100%)"
	@echo "  Cobertura esperada: ~75%"
	@echo ""
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(GREEN)üöÄ COMANDOS R√ÅPIDOS$(NC)"
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo ""
	@echo "  $(YELLOW)make test-validation$(NC)     # ‚úÖ Recomendado: Tests de Zod (100% funcionando)"
	@echo "  $(YELLOW)make test-watch$(NC)          # üëÄ Modo watch para desarrollo"
	@echo "  $(YELLOW)make test-coverage$(NC)       # üìä Ver cobertura de c√≥digo"
	@echo ""
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"

test: ## üß™ Ejecutar todos los tests
	@echo "$(GREEN)üß™ Ejecutando todos los tests...$(NC)"
	@echo "$(YELLOW)‚ö†Ô∏è  Nota: Algunos tests pueden fallar debido a ES modules$(NC)"
	npm test
	@echo "$(GREEN)‚úÖ Tests completados$(NC)"

test-validation: ## ‚úÖ Ejecutar tests de validaci√≥n Zod (100% funcionando)
	@echo "$(GREEN)‚úÖ Ejecutando tests de validaci√≥n Zod...$(NC)"
	@echo "$(YELLOW)üìã Tests: 42 tests de schemas de validaci√≥n$(NC)"
	npm run test:validation
	@echo "$(GREEN)‚úÖ Tests de validaci√≥n completados$(NC)"

test-unit: ## üî¨ Ejecutar tests unitarios de services
	@echo "$(GREEN)üî¨ Ejecutando tests unitarios...$(NC)"
	@echo "$(YELLOW)üìã Tests: ProductService, CategoryService$(NC)"
	npm run test:unit
	@echo "$(GREEN)‚úÖ Tests unitarios completados$(NC)"

test-integration: ## üåê Ejecutar tests de integraci√≥n de APIs
	@echo "$(GREEN)üåê Ejecutando tests de integraci√≥n...$(NC)"
	@echo "$(YELLOW)üìã Tests: product-api.ts con mocks de AWS$(NC)"
	npm run test:integration
	@echo "$(GREEN)‚úÖ Tests de integraci√≥n completados$(NC)"

test-helpers: ## üõ†Ô∏è  Ejecutar tests de funciones helper
	@echo "$(GREEN)üõ†Ô∏è  Ejecutando tests de helpers...$(NC)"
	@echo "$(YELLOW)üìã Tests: zod-validator.ts$(NC)"
	npm test -- test/helpers
	@echo "$(GREEN)‚úÖ Tests de helpers completados$(NC)"

test-watch: ## üëÄ Ejecutar tests en modo watch (√∫til para desarrollo)
	@echo "$(GREEN)üëÄ Iniciando tests en modo watch...$(NC)"
	@echo "$(YELLOW)üí° Presiona 'q' para salir$(NC)"
	npm run test:watch

test-coverage: ## üìä Ejecutar tests con reporte de coverage
	@echo "$(GREEN)üìä Ejecutando tests con coverage...$(NC)"
	npm run test:coverage
	@echo "$(GREEN)‚úÖ Reporte de coverage generado en coverage/$(NC)"
	@echo "$(YELLOW)üí° Abre coverage/lcov-report/index.html para ver el reporte$(NC)"

test-all: test-validation test-unit test-integration test-helpers ## üöÄ Ejecutar todos los tipos de tests secuencialmente
	@echo "$(GREEN)üéâ Todos los tests completados$(NC)"

# ============================================
# 6Ô∏è‚É£ GESTI√ìN DE MONGODB
# ============================================

configure-mongodb: ## Configurar o actualizar MongoDB Secret sin desplegar
	@if [ -z "$(MONGODB_URI)" ]; then \
		echo "$(RED)‚ùå ERROR: Debes configurar MONGODB_URI$(NC)"; \
		echo "$(YELLOW)Uso: make configure-mongodb MONGODB_URI='mongodb://...'$(NC)"; \
		exit 1; \
	fi
	$(call update_mongodb_secret,$(MONGODB_URI))
	@echo ""
	@echo "$(GREEN)‚úÖ Para aplicar cambios en Lambda, ejecuta: make update$(NC)"

mongodb-status: ## Ver estado del MongoDB Secret en AWS Secrets Manager
	@echo "$(BLUE)üîê Estado del MongoDB Secret:$(NC)"
	@echo ""
	@aws secretsmanager get-secret-value \
		--secret-id $(MONGODB_SECRET_NAME) \
		--region $(AWS_REGION) \
		--query 'SecretString' \
		--output text 2>/dev/null | jq . || \
	echo "$(YELLOW)‚ö†Ô∏è  Secret no encontrado. Ejecuta: make configure-mongodb MONGODB_URI='...'$(NC)"

# ============================================
# TARGET POR DEFECTO
# ============================================

.DEFAULT_GOAL := help
