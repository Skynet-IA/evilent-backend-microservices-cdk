name: ğŸ” Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Escanear cada domingo a las 2 AM UTC
    - cron: '0 2 * * 0'

env:
  NODE_VERSION: '20'
  AWS_REGION: 'eu-central-1'

jobs:
  security-scan:
    name: ğŸ” Security & Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      # âœ… PASO 1: Checkout
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # âœ… PASO 2: Setup Node.js (user-service)
      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }} - user-service
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'BACKEND/user-service/package-lock.json'

      # âœ… PASO 3: Install dependencies (user-service)
      - name: ğŸ“¦ Install user-service dependencies
        run: npm ci
        working-directory: BACKEND/user-service

      # âœ… PASO 4: npm audit (user-service)
      - name: ğŸ” npm audit - user-service
        run: npm audit --audit-level=moderate
        working-directory: BACKEND/user-service
        continue-on-error: true

      # âœ… PASO 5: Snyk scan (user-service)
      - name: ğŸ” Snyk scan - user-service
        run: |
          npm install -g snyk
          snyk test --severity-threshold=high || true
        working-directory: BACKEND/user-service
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN || 'disabled' }}

      # âœ… PASO 5b: Setup Node.js (product-service)
      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }} - product-service
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'BACKEND/product-service/package-lock.json'

      # âœ… PASO 6: Install dependencies (product-service)
      - name: ğŸ“¦ Install product-service dependencies
        run: npm ci
        working-directory: BACKEND/product-service

      # âœ… PASO 7: npm audit (product-service)
      - name: ğŸ” npm audit - product-service
        run: npm audit --audit-level=moderate
        working-directory: BACKEND/product-service
        continue-on-error: true

      # âœ… PASO 8: Snyk scan (product-service)
      - name: ğŸ” Snyk scan - product-service
        run: |
          npm install -g snyk
          snyk test --severity-threshold=high || true
        working-directory: BACKEND/product-service
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN || 'disabled' }}

      # âœ… PASO 9: GitLeaks - Secrets detection
      - name: ğŸ” GitLeaks scan - Secrets detection
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE || '' }}
        with:
          config: .gitleaks.toml

      # âœ… PASO 10: TruffleHog - Secrets verification
      - name: ğŸ” TruffleHog scan - Secrets verification
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified
        continue-on-error: true

      # âœ… PASO 11: Dependency Check (OWASP)
      - name: ğŸ” OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'EVILENT'
          path: '.'
          format: 'JSON'
          args: >
            --enableExperimental
            --enableRetired
        continue-on-error: true

      # âœ… PASO 12: Upload Dependency Check results
      - name: ğŸ“¤ Upload OWASP results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: dependency-check-report.json
          retention-days: 30
        continue-on-error: true

      # âœ… PASO 13: Analyze security results
      - name: ğŸ“Š Security Analysis Report
        if: always()
        run: |
          echo "ğŸ” SECURITY SCAN REPORT"
          echo "======================="
          echo ""
          echo "âœ… Escaneos ejecutados:"
          echo "  1. npm audit (OWASP Top 10 vulnerabilities)"
          echo "  2. Snyk (dependency vulnerabilities)"
          echo "  3. GitLeaks (secrets detection)"
          echo "  4. TruffleHog (secrets verification)"
          echo "  5. OWASP Dependency-Check (comprehensive analysis)"
          echo ""
          echo "ğŸ“‹ PrÃ³ximos pasos:"
          echo "  1. Revisar reportes en Artifacts"
          echo "  2. Corregir vulnerabilidades crÃ­ticas (HIGH, CRITICAL)"
          echo "  3. Documentar excepciones en SECURITY.md"
          echo ""
          echo "ğŸ¯ Reglas aplicadas:"
          echo "  âœ… REGLA #2: No secrets hardcodeados"
          echo "  âœ… REGLA #5: ValidaciÃ³n de dependencias"
          echo "  âœ… REGLA #6: Defense in depth (mÃºltiples escaners)"

      # âœ… PASO 14: Summary
      - name: ğŸ“Š Scan Summary
        if: always()
        run: echo "âœ… Security scan completed for ${{ github.ref }}"

